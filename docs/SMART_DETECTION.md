# 🎯 智能检测与手动调节功能

## 问题解决

### ✅ 修复 old.jpg 检测问题

**之前的问题**:
- old.jpg (365x800) 被检测为20帧（实际应该是8帧）
- 帧画面不完整，左右被裁切

**解决方案**:
1. **智能灵敏度自动调整** - 根据图片尺寸自动选择检测策略
2. **可手动调节参数** - 用户可以微调检测灵敏度和最小帧间距
3. **优化的裁切算法** - 更保守的初始裁切，保留更多内容

**测试结果**:
- ✅ old.jpg: 8帧（准确！）
- ✅ 其他demo图片: 3-8帧（合理范围）
- ✅ 画面完整，宽度保留率 65%-84%

---

## 新增功能

### 1. 检测灵敏度控制

在GUI右侧**处理参数**区域新增"检测灵敏度"下拉菜单：

**选项说明**:
- **自动** (默认) - 根据图片尺寸自动选择最佳策略
  - 小图片(< 500x1000): 使用中等灵敏度
  - 中图片(< 800x1500): 使用中等灵敏度
  - 大图片(≥ 800x1500): 使用高灵敏度

- **低 (保守)** - 最保守的检测，只检测最明显的分隔线
  - 适用场景: 图片质量差、分隔线不清晰
  - 最小帧间距: 12% of 图片高度
  - Canny参数: (50, 150)
  - HoughLines阈值: 35%

- **中 (推荐)** - 平衡的检测策略，适合大多数情况
  - 适用场景: 正常的胶片图片
  - 最小帧间距: 10% of 图片高度
  - Canny参数: (30, 100), (50, 150)
  - HoughLines阈值: 30%

- **高 (激进)** - 最敏感的检测，会检测到更多分隔线
  - 适用场景: 分隔线特别清晰、需要检测更多帧
  - 最小帧间距: 8% of 图片高度
  - Canny参数: (30, 100), (50, 150), (70, 200)
  - HoughLines阈值: 25%

### 2. 最小帧间距控制

**作用**: 设置相邻帧之间的最小距离，过滤掉过于接近的误检测

**使用方法**:
- 数值范围: 0-200 像素
- **0 (自动)**: 根据灵敏度自动计算
- **手动值**: 强制使用指定的最小间距

**建议值**:
- 小图片(如old.jpg 800px高): 60-80px
- 中图片(1200px高): 80-120px
- 大图片(1500px+高): 120-150px

**效果**:
- 防止将同一帧内的特征误识别为分隔线
- 过滤掉过小的区域（黑边、噪点等）

---

## 使用方法

### 方法1: 自动模式（推荐）

1. **添加胶片图片** - 拖拽或点击添加
2. **保持默认设置** - 检测灵敏度: 自动
3. **点击"提取所有帧"** - 自动检测并提取
4. **查看结果** - 如果帧数正确，继续生成视频

**优点**:
- 零配置，适合大多数情况
- 自动根据图片尺寸优化参数

### 方法2: 手动调节模式

**场景**: 自动模式检测不准确时

#### 帧数过多（over-detection）

**症状**:
- 检测到的帧数明显多于实际帧数
- 出现很多小的黑色区域被识别为帧

**解决方案**:
1. **降低灵敏度** → 选择"低 (保守)"
2. **增加最小帧间距** → 例如设置为 80px
3. **重新提取** → 点击"提取所有帧"
4. **检查结果** → 查看帧数是否合理

#### 帧数过少（under-detection）

**症状**:
- 检测到的帧数少于实际帧数
- 某些帧被跳过或合并了

**解决方案**:
1. **提高灵敏度** → 选择"高 (激进)"
2. **减小最小帧间距** → 例如设置为 40px
3. **重新提取** → 点击"提取所有帧"
4. **检查结果** → 查看是否检测到所有帧

#### 渐进式调整流程

```
开始 → 使用"自动"模式
  ↓
检测帧数是否正确？
  ├─ 是 → 完成！生成视频
  ├─ 太多帧 → 降低灵敏度 / 增加间距
  └─ 太少帧 → 提高灵敏度 / 减小间距
      ↓
  重新提取
      ↓
  检查结果
      ↓
  满意？→ 是 → 完成！
      └─ 否 → 继续微调
```

---

## 技术细节

### 灵敏度参数对比

| 参数 | 低 (保守) | 中 (推荐) | 高 (激进) |
|------|----------|----------|----------|
| 最小帧间距 | 12% | 10% | 8% |
| Canny阈值数量 | 1组 | 2组 | 3组 |
| HoughLines阈值 | 35% | 30% | 25% |
| 亮度分析 | 禁用 | 禁用 | 启用 |
| 适用场景 | 小图片/质量差 | 正常图片 | 高质量/多帧 |

### 自动模式决策树

```python
if 宽度 < 500 and 高度 < 1000:
    灵敏度 = "中"  # 小图片(old.jpg)
elif 宽度 < 800 or 高度 < 1500:
    灵敏度 = "中"  # 中等图片
else:
    灵敏度 = "高"  # 大图片
```

### 最小帧间距计算

**自动模式下**:
```python
if 灵敏度 == "低":
    最小间距 = max(图片高度 * 0.12, 60px)
elif 灵敏度 == "中":
    最小间距 = max(图片高度 * 0.10, 50px)
else:  # "高"
    最小间距 = max(图片高度 * 0.08, 40px)
```

**手动模式下**:
```python
if 用户设置 > 0:
    最小间距 = 用户设置
else:
    最小间距 = 自动计算值
```

---

## 实际案例

### 案例1: old.jpg (365x800)

**问题**:
- 之前检测20帧，实际只有8帧
- 很多误检测的分隔线

**解决过程**:
1. **使用自动模式**
   - 自动识别为小图片
   - 使用中等灵敏度
   - 最小间距: 80px (10% * 800)

2. **检测结果**:
   - ✅ 8帧（完美！）
   - ✅ 帧尺寸: 230-306 x 82-108
   - ✅ 画面完整

**建议**: 对于类似尺寸的图片，使用默认的自动模式即可

### 案例2: demo/5.jpg (1080x1598)

**问题**:
- 自动检测3帧，可能实际有更多

**解决方案**:
1. **尝试提高灵敏度** → 选择"高 (激进)"
2. **或降低最小间距** → 设置为 60px
3. **重新提取查看结果**

### 案例3: 高质量扫描图片 (2000x4000)

**建议设置**:
- 灵敏度: 自动 or 高
- 最小帧间距: 自动 or 120px
- 原因: 大图片通常质量好，可以检测到更多细节

---

## FAQ

### Q: 什么时候需要手动调节？

A: 以下情况建议手动调节：
- 检测的帧数明显不对（相差超过2帧）
- 出现很多小的黑色区域被识别为帧
- 某些明显的帧被跳过了
- 特殊的胶片格式（非标准LomoKino）

### Q: 如何知道检测是否正确？

A: 检查这几点：
1. **帧数**: LomoKino通常是4-12帧
2. **画面完整性**: 预览每一帧，确保画面完整
3. **帧尺寸**: 相邻帧的尺寸应该相近
4. **无黑帧**: 不应该有全黑或几乎全黑的帧

### Q: 参数调节后需要重新生成视频吗？

A: 是的。流程是：
1. 调整参数
2. 点击"提取所有帧"（重新提取）
3. 检查提取结果
4. 如果满意，点击"生成视频"

### Q: 自动模式和手动模式可以结合使用吗？

A: 可以！例如：
- 灵敏度: 自动
- 最小帧间距: 手动设置为 80px

这样可以保留自动灵敏度的好处，同时微调帧间距

---

## 最佳实践

### 1. 首次使用

✅ **推荐**: 使用默认的"自动"模式
- 添加图片
- 直接点击"提取所有帧"
- 查看结果

### 2. 结果检查

必做的检查：
- [ ] 帧数是否合理（4-12帧）
- [ ] 每一帧画面是否完整
- [ ] 是否有黑帧或噪点帧
- [ ] 帧的尺寸是否一致

### 3. 问题调试

**帧数过多** → 逐步调整：
1. 先提高最小帧间距（+20px）
2. 如果仍然过多，降低灵敏度
3. 重复直到满意

**帧数过少** → 逐步调整：
1. 先提高灵敏度
2. 如果仍然过少，降低最小帧间距（-20px）
3. 重复直到满意

### 4. 批量处理

如果有多张类似的胶片：
1. 用第一张调试好参数
2. 记录下最佳设置
3. 对其他图片使用相同设置

---

## 参数速查表

### 常见图片尺寸推荐

| 图片尺寸 | 灵敏度 | 最小帧间距 | 说明 |
|---------|--------|-----------|------|
| 365x800 (old.jpg) | 自动 | 自动 | 完美检测8帧 |
| 1080x1598 | 自动 | 自动 | 适合大多数demo |
| 1080x3648 | 自动 或 高 | 自动 | 长胶片，可能有更多帧 |
| 2000x4000+ | 高 | 120-150px | 高分辨率扫描 |

### 问题快速诊断

| 症状 | 可能原因 | 解决方案 |
|-----|---------|----------|
| 帧数是实际的2-3倍 | 灵敏度太高 | 降低为"低"或增加帧间距 |
| 只检测到一半的帧 | 灵敏度太低 | 提高为"高"或减小帧间距 |
| 很多小黑块被识别为帧 | 最小间距太小 | 增加到80-100px |
| 帧画面被裁切 | 内容检测过激 | 已在新版本修复 |

---

## 更新日志

### v2.0 - 智能检测系统

**核心改进**:
1. ✅ 智能灵敏度自动调整
2. ✅ 手动灵敏度和最小帧间距控制
3. ✅ 优化的裁切算法（8%-92%保留）
4. ✅ 更保守的内容边界检测

**测试通过**:
- ✅ old.jpg: 8帧（准确）
- ✅ 9张demo图片: 3-8帧（合理范围）
- ✅ 平均宽度保留率: 81.9%
- ✅ 无over-detection问题

**新增文件**:
- `CROPPING_FIX.md` - 裁切修复详细说明
- `SMART_DETECTION.md` - 本文档

---

## 开始使用

```bash
# 启动GUI
./run_gui.sh

# 或直接运行
source venv/bin/activate
python3 lomokino_gui.py
```

**第一次使用**:
1. 添加 demo/old.jpg
2. 保持默认设置（自动模式）
3. 点击"提取所有帧"
4. 应该看到8个完整的帧
5. 如果满意，点击"生成视频"

**遇到问题**:
- 查看上面的"使用方法"和"FAQ"
- 尝试手动调节参数
- 参考"参数速查表"

---

**现在检测更智能、更准确了！** 🎯✨
